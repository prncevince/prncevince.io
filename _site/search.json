[
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html",
    "href": "posts/geo/north-india-floods-2023/index.html",
    "title": "North India Floods of October 2023",
    "section": "",
    "text": "Figure¬†1: A split web map displaying avalanche damage to South Lhonak Lake (a glacier lake) in the Indian Himalayan Region. The pre & post event satellite imagery was obtained from Maxar‚Äôs Open Data Program."
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#tldr",
    "href": "posts/geo/north-india-floods-2023/index.html#tldr",
    "title": "North India Floods of October 2023",
    "section": "TLDR",
    "text": "TLDR\nI quickly visualize Maxar‚Äôs recent release in response to the flooding events in the northern Himalayan region of Sikkim, India in October of 2023. Figure¬†4 displays a demo of this. You can use Figure¬†3 to interact with the web map for yourself.\nMy previous post is a technical deep dive that covers the tooling used behind these techniques."
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#intro",
    "href": "posts/geo/north-india-floods-2023/index.html#intro",
    "title": "North India Floods of October 2023",
    "section": "Intro",
    "text": "Intro\nOn the morning of October 12th, 2023, Maxar released an activation alert within their Open Data Program on the recent flooding that devastated Sikkim, India in the Indian Himalayan Region last week on Wednesday October 4th. It has been reported that the flooding was caused by a Glacial Lake Outburst Flood (GLOF) from a melting glacier at South Lhonak Lake. Ultimately, the flooding triggered from the glacier lake area destroyed the Chungthang Dam and it‚Äôs surrounding town miles away downstream.\nFigure¬†2 captures the area between the South Lhonak Lake (the glacier lake) and the Chungthang Dam.\n\n\n\n\n\n\nFigure¬†2: Google Maps view from South Lhonak Lake (upper left) to Chungthang Dam (bottom right). Source\n\n\n\nHere I use open source technologies to build a web map that displays the released satellite imagery over the region. In particular, Figure¬†3 is a web map that showcases before and after the GLOF took place to help make visual comparisons of the disaster.\nAdditionally, Dan Shugar previously released an in-depth thread of the GLOF that triggered the flooding using Planet Labs imagery from the SuperDove satellites. It‚Äôs a great resource (below) to understand the chain of events that happened during the floods."
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#data-aggregation",
    "href": "posts/geo/north-india-floods-2023/index.html#data-aggregation",
    "title": "North India Floods of October 2023",
    "section": "Data Aggregation",
    "text": "Data Aggregation\n\n\nNorth India Flood Event Image Tile Aggregation - Maxar‚Äôs Open Data Program\nimport time\nimport numpy as np\nimport pandas as pd\nimport geopandas as gpd\n\nstart = time.time()\n\np_datasets = 'https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets.csv'\nd_maxar = pd.read_csv(p_datasets)\np_top = 'https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/'\np_bottom = '.geojson'\n\nevent = 'India-Floods-Oct-2023'\nd_event = d_maxar[d_maxar.dataset == event]\nl_gdf = [gpd.read_file(p_top+d+p_bottom).assign(event = d) for d in d_event['dataset'].to_list()]\nd_tiles = (pd.concat(l_gdf, ignore_index=True))\n# changes column order - puts event & geometry first\nd_tiles = d_tiles[d_tiles.columns[-2::][::-1].append(d_tiles.columns[:-2])]\n\ndict_event = {\n    'India-Floods-Oct-2023': ['2023-10-04 00:00:00', 'https://www.maxar.com/open-data/india-floods-oct-2023'],\n}\n\nd_event = pd.DataFrame.from_dict(dict_event, orient='index', columns=['t_event', 'source'])\nd_event = (d_event\n .reset_index(names='event')\n .assign(t_event = pd.to_datetime(d_event.t_event, utc=True).to_list())\n .sort_values('t_event', ascending=False)\n .reset_index(drop=True)\n)\n\n# right join removes old datasets stored in opengeos/maxar-open-data\nd_tiles = pd.merge(left=d_tiles, right=d_event, how='right', left_on='event', right_on='event')\nd_tiles = d_tiles.assign(pre_post = np.where(d_tiles.datetime &lt; d_tiles.t_event, 'pre', 'post'))\nd_tiles.insert(1, 'pre_post', d_tiles.pop('pre_post'))\n# sort by latest event date \nd_tiles = (d_tiles\n .assign(latest = d_tiles.groupby('event')['t_event'].transform('max'))\n .sort_values(['latest','datetime'], ascending=False)\n .drop('latest', axis=1)\n .reset_index(drop=True)\n)\n\nend = time.time()\n\nprint(str(round(end-start, 2))+' seconds')\n\n\n0.29 seconds\n\n\n\n\nPre & Post Event MosaicJSON Creation\nimport os\nfrom cogeo_mosaic.mosaic import MosaicJSON\nfrom cogeo_mosaic.backends import MosaicBackend\n\nfor e in np.unique(d_tiles.event):\n    start = time.time()\n    d = d_tiles[d_tiles.event == e].reset_index(drop=True)\n    # write output\n    os.makedirs('data/'+e, exist_ok=True)\n    for i in ['pre', 'post']:\n        images = d[d.pre_post == i].reset_index(drop=True).visual.tolist()\n        if len(images) &gt; 0:\n            mosaic = MosaicJSON.from_urls(images)\n            with MosaicBackend('data/'+e+'/mosaic-tiles-'+i+'.json', mosaic_def=mosaic) as f:\n                f.write(overwrite=True)\n    end = time.time()\n    print(e+' Pre/Post MosaicJSON Time: '+str(round(end-start, 2))+'s')\n\n\nIndia-Floods-Oct-2023 Pre/Post MosaicJSON Time: 66.61s\n\n\n\n\nImage Footprint Metadata Aggregation\ncols_tile = [\n    'visual', 'tile:data_area', 'tile:clouds_area', 'tile:clouds_percent',\n    'view:off_nadir', 'view:azimuth', 'view:incidence_angle', 'view:sun_azimuth', 'view:sun_elevation',\n    'gsd', 'proj:bbox', 'quadkey', 'utm_zone', 'grid:code'\n]\n# create bounding box from image footprint instead of these\ncols_drop = ['proj:bbox', 'quadkey', 'grid:code']\n\ncols_tile_unique = ['utm_zone', 'tile:clouds_area']\ncols_tile_mean = ['gsd', 'tile:clouds_percent', 'view:off_nadir', 'view:azimuth', 'view:incidence_angle', 'view:sun_azimuth', 'view:sun_elevation']\ncols_tile_footprint = ['event', 'pre_post', 'catalog_id']\n\nd_agg = (d_tiles[cols_tile_footprint+cols_tile_unique]\n .groupby(cols_tile_footprint)\n .agg({\n     'utm_zone': lambda x: np.unique(x).tolist(),\n     'tile:clouds_area': lambda x: round(sum(x), 2),\n })\n)\nd_agg_mean = (d_tiles[cols_tile_footprint+cols_tile_mean]\n .groupby(cols_tile_footprint)\n .agg(lambda x: round(np.mean(x), 2))\n)\n\nd_foot = (d_tiles[d_tiles.columns.difference(cols_drop+cols_tile_unique+cols_tile_mean).to_list()]\n .dissolve(cols_tile_footprint, aggfunc = 'first')\n # same index - can left join aggregates on index by default\n .join(d_agg).join(d_agg_mean)\n # add index back to dataframe\n .reset_index()\n)\n# split because `d` carries from original when chaining\nd_foot = (d_foot\n .assign(\n     # uses equal area projection - converts km^2 original units \n     footprint_data_area = lambda d: round(d.geometry.to_crs(epsg=6933).area/1e6, 2),\n     bbox = d_foot.geometry.bounds.applymap(lambda x: round(np.mean(x), 2)).values.tolist()\n )\n .sort_values(['t_event', 'datetime'], ascending=False)\n .reset_index(drop=True)\n .rename(columns={\n     'tile:clouds_area': 'footprint:clouds_area', 'tile:clouds_percent': 'footprint:clouds_percent',\n     'footprint_data_area': 'footprint:data_area'\n })\n)"
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#analysis",
    "href": "posts/geo/north-india-floods-2023/index.html#analysis",
    "title": "North India Floods of October 2023",
    "section": "Analysis",
    "text": "Analysis\nWe see that there are currently 5 images acquisitions (image footprints) released from before the flooding and 1 image acquisition taken after the flooding.\n\n\nCode\nd = pd.DataFrame(\n  (d_foot\n  .groupby(['event', 'pre_post'])\n  ).size(),\n  columns=['count']\n).reset_index()\nd = (d[d.event == event]\n .reset_index(drop=True)\n)\nd.style.hide(axis=\"index\")\n\n\n\n\n\n\n\nevent\npre_post\ncount\n\n\n\n\nIndia-Floods-Oct-2023\npost\n1\n\n\nIndia-Floods-Oct-2023\npre\n5"
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#web-map",
    "href": "posts/geo/north-india-floods-2023/index.html#web-map",
    "title": "North India Floods of October 2023",
    "section": "Web Map",
    "text": "Web Map\n\n\nSplit Web Map of North India Floods\nimport re\nimport leafmap\nimport leafmap.foliumap\nfrom folium import Element\nfrom leafmap2 import add_geojson2, add_gdf2\nleafmap.foliumap.Map.add_geojson2 = add_geojson2\nleafmap.foliumap.Map.add_gdf2 = add_gdf2\n\n# 'p' for path | 'm' for mosaic | 'f' for footprint\nevent = 'India-Floods-Oct-2023'\npm_top = 'https://raw.githubusercontent.com/prncevince/mosaicjson-examples/main/maxar-open-data/'\npm_end_pre = '/mosaic-tiles-pre.json'\npm_end_post = '/mosaic-tiles-post.json'\n\ncols_drop = ['source', 'proj:epsg', 't_event']\nd = d_foot[d_foot.event == event]\nd.drop(cols_drop, axis=1, inplace=True)\n\nm = leafmap.foliumap.Map()\ndef style_footprints(color, fillOpacity, weight):\n    style = {\n        'color': color, 'fillOpacity': fillOpacity, 'weight': weight\n    }\n    return style\nbasemap = {  \n  \"url\": \"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}\",\n  \"attribution\": \"Google\",\n  \"name\": \"Google Satellite\",\n}\nm.add_tile_layer(**basemap, shown=True)\nm.add_stac_layer(pm_top+event+pm_end_pre, name=\"Pre-Event - Mosaic\", attribution=\"Maxar Technologies\", shown=True)\nm.add_stac_layer(pm_top+event+pm_end_post, name=\"Post-Event - Mosaic\", attribution=\"Maxar Technologies\")\nm.add_gdf2(\n    d[d.pre_post == 'pre'], \"Pre Event - Image Footprints\",\n    style=style_footprints('blue', 0, 1.5), info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_gdf2(\n    d[d.pre_post == 'post'], \"Post Event - Image Footprints\",\n    style=style_footprints('red', 0, 1.5), info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nwith open('./popup-fix.js') as f: js_po = f.read()\nwith open('./side-by-side.js') as f: js_sbs = f.read()\nwith open('./split-map-layout.css') as f: css_sbs_l = f.read()\nwith open('./split-map-range.css') as f: css_sbs_r = f.read()\n#with open('./split-map.js') as f: js_sm = f.read()\n# must render 1st to add script after - otherwise adds JS before Leaflet L.Map assignment\nm.get_root().render()\n# add map & geojson layer variables to script\nvar_map = m.get_name()\nvar_geojson_lgs = str([i for i in m._children.keys() if re.search('^geo_json_', i) is not None]).replace(\"'\", \"\")\ntile_layers = [i for i in m._children.keys() if re.search('^tile_layer_', i) is not None]\n# need to know the order of your tiles for adding as split map\n# an area of multiple layers can be passed to left & right arguments of L.control.sideBySide\n# however, it's pretty buggy when passing more than one layer\ni_all = [0,1,2] # a basemap, pre, & post event\ni_left = [2]\ni_right = [0]\nl_lleft = str([j for i, j in enumerate(tile_layers) if i in i_left]).replace(\"'\", \"\")\nl_lright = str([j for i, j in enumerate(tile_layers) if i in i_right]).replace(\"'\", \"\")\nm.get_root().header.add_child(Element('&lt;style&gt;'+css_sbs_l+'&lt;/style&gt;'))\nm.get_root().header.add_child(Element('&lt;style&gt;'+css_sbs_r+'&lt;/style&gt;'))\nm.get_root().script.add_child(Element(js_po.format(m=var_map, lg_geo=var_geojson_lgs)))\nm.get_root().script.add_child(Element(js_sbs))\nm.get_root().script.add_child(Element('L.control.sideBySide({l_lleft}, {l_lright}).addTo({m});'.format(l_lleft=l_lleft, l_lright=l_lright, m=var_map)))\n\n\n\n\n\n\n\n\n\nFigure¬†3: A split web map of Pre/Post Event Imagery after the Flooding in Northern India. Sources: opengeos/maxar-open-data Github & Maxar Open Data Program STAC"
  },
  {
    "objectID": "posts/geo/north-india-floods-2023/index.html#wrap-up",
    "href": "posts/geo/north-india-floods-2023/index.html#wrap-up",
    "title": "North India Floods of October 2023",
    "section": "Wrap-up",
    "text": "Wrap-up\nIf you have any thoughts or questions, feel free to let me know what you think in the comments below. You‚Äôll need to sign in to your GitHub account to do so. Like my work? Feel free to reach out.\nWe only have one rock, and it‚Äôs a beautiful one. Thanks for reading! ‚úåÔ∏èüåç\n\n\n\n\n\n\nFigure¬†4: 2023 South Lhonak Lake Sikkim, India - Maxar Open Data Program Leaflet Split Map"
  },
  {
    "objectID": "posts/index.html",
    "href": "posts/index.html",
    "title": "Big & tiny spatial thoughts",
    "section": "",
    "text": "Order By\n       Default\n         \n          Date - Oldest\n        \n         \n          Date - Newest\n        \n         \n          Updated - Oldest\n        \n         \n          Updated - Newest\n        \n     \n  \n\n\n\n\n\n\n\n\nDesigning aesthetic maps in R with ggplot2 & svglite\n\n\n9 min\n\n\nA method to create beautiful lightweight interactive maps in R using ggplot2 and SVG (Scalar Vector Graphics).\n\n\n\nOctober 29, 2023\n\n\n\n\n\nOctober 30, 2023\n\n\n\n\n\n\n\n\n\n\n\nNorth India Floods of October 2023\n\n\n3 min\n\n\nA quick turn analysis to visually compare events caused by the Glacial Lake Outburst Flood in the Indian Himalayan Region of Sikkim during early October of 2023.\n\n\n\nOctober 12, 2023\n\n\n\n\n\nFebruary 18, 2024\n\n\n\n\n\n\n\n\n\n\n\nVisualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program\n\n\n13 min\n\n\nA deep dive into visualizing satellite imagery from Maxar‚Äôs ODP on-the-fly using STAC, dynamic tiling, and Leaflet.\n\n\n\nOctober 2, 2023\n\n\n\n\n\nOctober 12, 2023\n\n\n\n\n\n\n\nNo matching items\n\n Back to top"
  },
  {
    "objectID": "SETUP.html",
    "href": "SETUP.html",
    "title": "Quarto Site Environment Setup",
    "section": "",
    "text": "Here‚Äôs all the setup.\n\nSetup quarto-shims.\nThen, run below to install & setup quarto. wget is required in your shell environment, can be installed on Mac via homebrew.\n./utils/download-quarto.sh\n\nSetup r-shims.\nCreate RStudio project within RStudio.\n\nrstudioapi::initializeProject()\n\nInitialize the renv environment. Important packages can be discovered in utils/deps.R.\n\nrenv::init()\n\n\nExplode on paper."
  },
  {
    "objectID": "SETUP.html#quarto",
    "href": "SETUP.html#quarto",
    "title": "Quarto Site Environment Setup",
    "section": "",
    "text": "Setup quarto-shims.\nThen, run below to install & setup quarto. wget is required in your shell environment, can be installed on Mac via homebrew.\n./utils/download-quarto.sh"
  },
  {
    "objectID": "SETUP.html#r",
    "href": "SETUP.html#r",
    "title": "Quarto Site Environment Setup",
    "section": "",
    "text": "Setup r-shims.\nCreate RStudio project within RStudio.\n\nrstudioapi::initializeProject()\n\nInitialize the renv environment. Important packages can be discovered in utils/deps.R.\n\nrenv::init()"
  },
  {
    "objectID": "SETUP.html#start",
    "href": "SETUP.html#start",
    "title": "Quarto Site Environment Setup",
    "section": "",
    "text": "Explode on paper."
  },
  {
    "objectID": "LICENSE.html",
    "href": "LICENSE.html",
    "title": "Creative Commons License",
    "section": "",
    "text": "Creative Commons License\nhttps://prncevince.xyz ¬© 2024 by Vincent Clemson is licensed under CC BY-NC-SA 4.0.\nTo view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/.\n\n\n\n\n Back to top"
  },
  {
    "objectID": "about/index.html",
    "href": "about/index.html",
    "title": "Vincent Clemson",
    "section": "",
    "text": "üëã I‚Äôm Vince. In 2017, I received my Bachelor of Science in mathematics & a minor in statistics from Penn State. Afterward, I spent 5+ years at what is now Peraton working a few Geospatial Intelligence data science missions on the NGA‚Äôs enterprise systems engineering contract. Recently, I was an AI Engineer at Booz Allen where I conducted statistical performance analyses against Earth observing satellite imagery object detection algorithms.\nI recently traveled ~13,000 miles by car across  to the West coast. I plan to continue to travel. I‚Äôm always searching for my next big (or tiny) adventure.\nI enjoy spatial analytics. I hope that I can help shed some light on spatial topics to those who are also interested with this site. It‚Äôs built with Quarto.\nWhen I‚Äôm not head down in geeky stuff, I enjoy salsa dancing, sports (go birds ü¶Ö), and jumping out of aircraft (did it once - was fun & a bit terrifying).\nIf you‚Äôre interesting in learning more about my career, here‚Äôs a web version of my r√©sum√©.\nAlso, feel free to contact me at vincent.clemson{@}gmail.com.\nThanks for stopping by. ‚úåÔ∏è\n\n\n Back to top"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "üëã Welcome to my site",
    "section": "",
    "text": "üëã Welcome to my site\n\nYou can learn more about me here.\nYou can find my posts on spatial analytics here.\n\n\n\nThanks for stopping by ‚úåÔ∏è"
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html",
    "href": "posts/geo/maps-ggplot-svglite/index.html",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "",
    "text": "Figure¬†1: A choropleth map visualizing the population within each county of the continental United States in 2015.  The map was designed using ggplot2. Saving the map using svglite and editing the output has the potential to create beautiful interactive & lightweight maps."
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#tldr",
    "href": "posts/geo/maps-ggplot-svglite/index.html#tldr",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "TLDR",
    "text": "TLDR\nI show off how to use R packages in the #rspatial & tidyverse ecosystems to build both aesthetic & interactive maps. I also use some slightly advanced web dev & scraping techniques to create the finished product.\nInteract with it yourself: Figure¬†4."
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#intro",
    "href": "posts/geo/maps-ggplot-svglite/index.html#intro",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "Intro",
    "text": "Intro\nAt the end of November, I plan on packing up my belongings and trekking 6,500 miles across the continental United States from Virginia out to the West coast (üó£Ô∏è roadtrip üõ£Ô∏è).\nBeing who I am, I figured it‚Äôd be a great idea to plot out the journey using R. Additionally, the #30DayMapChallenge is approaching, so I figured that it was a great time to create a new thing in preparation for the challenge. Most of my time went into development over the past week, so the next steps for me are the trip planning, but I think the proof of concept is a great start!"
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#thoughts-on-data-driven-javascript-visuals",
    "href": "posts/geo/maps-ggplot-svglite/index.html#thoughts-on-data-driven-javascript-visuals",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "Thoughts on Data Driven JavaScript Visuals",
    "text": "Thoughts on Data Driven JavaScript Visuals\nPlots & maps are cool, and interactive plots can be even cooler, but the bloat of adding external JavaScript libraries can sometimes create a performance hit to a user‚Äôs experience on the web. A typically approach within the R user community to embed data driven interactive graphics in web content involves using the incredible htmlwidgets package. There are several HTML widget R packages. These packages work by using htmlwidgets to bind & format data as JSON input to their respective JavaScript visualization libraries and then to output the results as an HTML element.\nMy biggest gripe with HTML widgets is that they embed the entire JavaScript library passed to them. So, if you say want 2 unique HTML widgets on your web page that are created from the same htmlwidgets ‚Äòbinding‚Äô R package, then you‚Äôll have 2 identical copies of the same JavaScript library downloaded to your web browser. Having the option to embed the library in say your web pages &lt;head&gt; element could help cut down on some of this bloat.\nAside from this, I think that being able to create data driven interactive graphics without the need for external JavaScript libraries has a lot of potential when it comes to creating beautiful plots in the browser. Building plots with SVG has been conquered by D3.js as well as many others that have taken significant influence from D3, such as plotly & highcharter. Additionally, Observable has changed the game when it comes to quickly prototyping & sharing new data visuals in the browser. Making it easier than ever before to collaborate & maximize one‚Äôs reach when developing a new dataviz powered by web technologies. In particular, its lead by Mike Bostock, one who I would call a super human with eons of data visualization expertise. At Observable, they‚Äôre building the Observable Plot library to help folks efficiently visualize tabluar data in the browser.\nPlot is inspired by the grammar of graphics style, which is the foundation that ggplot2 was built upon. I think that the ability to turn a ggplot into a an interactive graphic can be extremely powerful and can open up many new doors into the world of dataviz. Using plotly and the incredible plotly::ggplotly designed by Carson Sievert is an htmlwidgets approach to doing this. The approach to use svglite to save ggplot2 created plots and then post process these graphics allows you to keep the design portion of the dataviz mostly outside of the web browser and within the Plot pane of your IDE (i.e.¬†RStudio). The choice to post process the SVG output within R allows one to minimize JavaScript library dependencies, but presents the challenge of making the SVG interactive.\nAll in all, I‚Äôm excited to see where this goes."
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#the-data",
    "href": "posts/geo/maps-ggplot-svglite/index.html#the-data",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "The data",
    "text": "The data\nI used the 2015 U.S. Census county population data stored within the usmap package. More updated U.S. Census data from the U.S Census Bureau can be accessed via the tidycencus and censusapi R packages.\nAs a precursor, I filtered out Alaska & Hawaii because I am not planning to travel that far just yet, i.e.¬†I want the focus of the plot to be on CONUS. I used the Albers equal area conic projection centered on the US. The proj4 string of the projection was highlighted in a neat post by Bob Rudis a few years back.\nThe key variable that I create here for the visual is the percentage of the population per state for each county. I ultimately display this using a log scale in the color palette of the plot to better visualize large differences in the county population. Additionally, this percentage gets used as hover text in the interactive figure.\n\nusapop-data.Rlibrary(sf)\nlibrary(dplyr)\nlibrary(usmap)\n\n# data load & format ----\n\nd &lt;- left_join(usmap::us_map(regions='county'), usmap::countypop, by = c('fips', 'abbr', 'county')) |&gt;\n  as_tibble()\n\n# must create individual polygons first before entire counties of multiple polygons\nd_sf &lt;- d |&gt; st_as_sf(coords = c('x', 'y'), crs = usmap::usmap_crs()) |&gt; st_transform(4326) |&gt;\n  group_by(group) |&gt;\n  summarise(\n    geometry = st_combine(geometry) |&gt; st_cast('POLYGON'),\n    across(c(abbr, pop_2015, full, county, fips), unique)\n  ) |&gt;\n  group_by(fips) |&gt;\n  summarise(\n    geometry = st_combine(geometry),\n    across(c(abbr, pop_2015, full, county), unique),\n    l_group = list(group)\n  ) |&gt;\n  mutate(pop_full = sum(pop_2015, na.rm = T), .by = full) |&gt;\n  mutate(\n    point = lapply(geometry, function(p) p |&gt; st_cast('POINT') |&gt;\n      suppressWarnings()) |&gt; st_sfc() |&gt; st_set_crs(4326),\n    county = sub(x = county, pattern = ' County', replacement = ''),\n    pop_perc = pop_2015/pop_full\n  ) |&gt;\n  mutate(\n    text = paste0(\n      sprintf(paste0(county, ', ', full, ' ', '%.2f%%'), 100*pop_perc),\n      # for mapping SVG elements\n      '|', lapply(geometry, length) |&gt; unlist()\n    )\n  )\n\n# ggplot ----\n## plot format objects ----\nproj &lt;- '+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs'\nd_sf_us &lt;- d_sf |&gt; filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  summarise(geometry = st_combine(geometry)) |&gt;\n  mutate(geometry = geometry |&gt; st_make_valid() |&gt; st_union()) |&gt;\n  st_transform(proj)\nd_sf_states &lt;- d_sf |&gt; group_by(full) |&gt; summarise(geometry = st_combine(geometry)) |&gt;\n  mutate(geometry = geometry |&gt; st_make_valid() |&gt; st_union(), .by = full) |&gt;\n  filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  st_transform(proj)\nd_sf_plot &lt;- d_sf |&gt;\n  filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  st_transform(proj)"
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#the-ggplot",
    "href": "posts/geo/maps-ggplot-svglite/index.html#the-ggplot",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "The ggplot",
    "text": "The ggplot\nWith the showtext package, I used a custom font that I downloaded from Fontsgeek, Black Chancery. Additionally, to give the plot a bit of a 3D effect, I added shadow using ggfx. It adds some good taste IMO.\nWhen it came to trying to save an identical copy of the rendered ggplot graphic within the RStudio Plot pane programmatically, I‚Äôve found this to be very challenging. The ggplot::ggsave function has width, height, unit, & dpi parameters that can be specified. There‚Äôs also a great post by Christophe Nicault on setting the text DPI via the showtext package to match the DPI used within ggsave by the PNG graphics device. However on my 14‚Äù MBP, these methods all seem to fall short, with the ggsave approach font being larger than the font displayed in the Plot pane. It seems that the Plot pane does some magic when it comes to resizing. You can right click your image & choose ‚ÄúSave image as‚Ä¶‚Äù, which allows you to save what you‚Äôre looking at to file.\nI think that there are benefits & drawbacks to both approaches. Below I provide the ggplot code version of the map. The last line of the snippet includes a ggsave call that builds a plot with text slightly bigger than what‚Äôs expected. Additionally, the ggfx shadow seems less prominent in the ggsave version, and the overall width / height of the plot content appear smaller as well.\nEven if we switch the dpi to 72, and calculate the same width / height of the RStudio pane version to get the same resolution image in the ggsave version, i.e.¬†both dpi & pixel width/height match amongst both files, we get even smaller text and other distortions.\nThus, I‚Äôve included both versions in Figure¬†2 for comparison, the version that I saved from the RStudio plot pane, as well as the ggsave version. MacOS Preview app info on the .png tells me that the plot pane version ends up saving with 72 dpi (dots per inch), while the ggsave version has 254 as I‚Äôve specified. Both files have near equivalent pixel size dimensions (3023 √ó 1889), with the key difference being the dpi.\n\nusapop-ggplot.Rlibrary(sf)\nlibrary(ggfx)\nlibrary(dplyr)\nlibrary(usmap)\nlibrary(tibble)\nlibrary(ggplot2)\nlibrary(showtext)\n\n# mbp 14\" dpi / height / width in inches\ndpi &lt;- 254\nwidth &lt;- 11.90157\nheight &lt;- 7.437008\n\nshowtext_opts(dpi = dpi)\nshowtext_auto(enable = TRUE)\nfont_add(\"Black Chancery\", \"BLKCHCRY.TTF\")\n\ng &lt;- ggplot(data = d_sf_plot) +\n  with_shadow(\n    sigma = 5, x_offset = 5, y_offset = 5,\n    geom_sf(data = d_sf_states, color = \"black\", fill = 'white')\n  ) +\n  geom_sf(mapping = aes(fill = log(pop_2015)), linewidth=0.1) +\n  scale_fill_continuous(low = 'yellow', high = 'darkgreen', na.value='yellow', guide = 'none') +\n  geom_sf(data = d_sf_states, color = \"black\", fill = 'transparent') +\n  labs(title = 'Population Across America') +\n  theme_void() +\n  theme(\n    plot.background = element_rect(fill = \"white\", color = \"white\"),\n    text = element_text(family='Black Chancery'),\n    plot.title = element_text(vjust = 0.01, hjust = 0.5, size = 75)\n  )\ngb &lt;- ggplot_build(g)\n\ng &lt;- g +\n  annotate(\n    \"text\", label = \"¬© Vincent Clemson\", family='Black Chancery', size = 14/.pt,\n    x = gb$layout$panel_params[[1]]$x_range[1]+1100000,\n    y = gb$layout$panel_params[[1]]$y_range[1]+500000,\n  )\nggsave(plot = g, width = width, height = height, unit = 'in', dpi = dpi, filename = 'usapop-ggplot-ggsave.png')\n\n\n\n\n\n\n\n\n\n\n\n\n(a) RStudio Plot Pane Version\n\n\n\n\n\n\n\n\n\n(b) ggsave Version\n\n\n\n\n\n\nFigure¬†2: Two ggplot versions of the county population map to compare save methods."
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#svg-xml-editting",
    "href": "posts/geo/maps-ggplot-svglite/index.html#svg-xml-editting",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "SVG & XML Editting",
    "text": "SVG & XML Editting\nSVG (Scalar Vector Graphics) is itself its own markup language, based in XML and similar to HTML. The key difference between HTML & SVG being that HTML specifies how text is displayed to the browser, while SVG describes how graphics are displayed.\nBecause SVG files are written as XML, they can be loaded as objects and edited in scripting languages, similar to how commonly used web scraping tools work. Using the xml2 & rvest packages in combination from the tidyverse can help us run query selectors on the XML markup to add and remove XML element nodes as necessary.\nUsing the svglite package/graphics device within ggsave function calls, we can convert & save ggplots to SVG elements, and even use our custom fonts within them.\n\n\n\n\n\n\nNote\n\n\n\nshowtext_auto(FALSE) should be ran within interactive R sessions that have set showtext_auto(enable = TRUE) before saving ggplots via ggsave to .svg.\n\n\nAdding Iteractivity\nUsing vanilla JavaScript, I add a tooltip that reads the title attribute of each county boundary SVG &lt;path&gt; within the created choropleth group (&lt;g&gt;) element, e.g &lt;g class=\"tooltip\"&gt;&lt;rect/&gt;&lt;text&gt;&lt;/text&gt;&lt;/g&gt;. The SVG tooltip element itself is a single &lt;rect/&gt; & &lt;text&gt; pair rapped in a group. When creating the SVG/XML document in R, I add it as the last graphic element in the &lt;svg&gt; container so that it displays on top of everything else. JavaScript handles updating the content of the &lt;text&gt; using event handlers on mouse movement. The tooltip was inspired by Lee Mason‚Äôs Basic SVG Tooltip Observable notebook. It differs in that it‚Äôs implemented as native SVG, rather than using a &lt;div&gt; wrapped in a &lt;foreignObject&gt;, which is incompatible in all browsers.\n\nCodesvgChoro = document.querySelector('svg.svglite &gt; g.choro')\nsvgBords = document.querySelector('svg.svglite &gt; g.borders')\nsvgBordE = document.querySelector('svg.svglite &gt; g.borders &gt; path.end')\ntooltipG = document.querySelector('svg.svglite g.tooltip')\ntooltipR = document.querySelector('svg.svglite g.tooltip rect')\ntooltipT = document.querySelector('svg.svglite g.tooltip text')\ntooltipT.innerHTML = 'A'\nconst pad = 4\nconst xR = 0.5 // for width of path\nconst yR = 0.5\nlet tooltipTBox = tooltipT.getBBox()\nlet hT = tooltipTBox.height\nlet wT = tooltipTBox.width\nlet hR = hT+pad*3+xR\nlet wR = wT+pad*2.5+yR\nlet xT = wR/2\nlet yT = hR/2\ntooltipR.setAttribute('x', xR)\ntooltipR.setAttribute('y', yR)\ntooltipT.setAttribute('x', xT)\ntooltipT.setAttribute('y', yT)\ntooltipR.setAttribute('width', `${wR}px`)\ntooltipR.setAttribute('height', `${hR}px`)\n// right & bottom pixel offseft\nconst mouseOffset = [0,0]\nconst svgBox = document.querySelector('svg.svglite').getBBox()\n\n// element to be replaced by hovered element\nsvgBords.insertAdjacentHTML('beforeend', '&lt;path class=\"end\"&gt;&lt;/path&gt;')\n\nsvgChoro.onmouseover = function(e) {\n  if (e.target.nodeName == 'path') {\n    const bbox = e.target.getBBox()\n    e.target.classList.add('hover', 'end')\n    bordersGEnd = document.querySelector('svg.svglite &gt; g.borders &gt; path.end')\n    // replacement of elements\n    const dummy = document.createComment('')\n    bordersGEnd.replaceWith(dummy)\n    e.target.replaceWith(bordersGEnd)\n    dummy.replaceWith(e.target)\n    showTooltip(bbox.x, bbox.y, bbox.width, bbox.height, e.target.getAttribute('title'))\n    // remove hover and put path elements back in original groups\n    e.target.onmouseout = function(e) {\n      e.target.classList.remove('hover', 'end')\n      svgChoro.appendChild(e.target)\n      svgBords.appendChild(bordersGEnd)\n    }\n  }\n}\n\nsvgBords.onmouseleave = hideTooltip\n// Chrome compatibility\nsvgChoro.onmouseleave = hideTooltip\n\nfunction hideTooltip(e) {\n  tooltipG.style.visibility = 'hidden'\n}\nfunction showTooltip(x, y, w, h, text) {\n  tooltipT.innerHTML = text\n  tooltipTBox = tooltipT.getBBox()\n  hT = tooltipTBox.height\n  wT = tooltipTBox.width\n  hR = hT+pad*2\n  wR = wT+pad*2\n  xT = wR/2\n  yT = hR/2\n  tooltipT.setAttribute('x', xT)\n  tooltipT.setAttribute('y', yT)\n  tooltipR.setAttribute('width', `${wR}px`)\n  tooltipR.setAttribute('height', `${hR}px`)\n  const bottom_target = [x-w/2-mouseOffset[0], y+h+mouseOffset[1]]\n  let xG = bottom_target[0]\n  let yG = bottom_target[1]\n  const tooltipRBox = tooltipR.getBBox()\n  // uses max tooltip size to not going over right edge\n  if (xG &gt; svgBox.width - tooltipRBox.width) { xG = x - (tooltipRBox.width &lt; 150 ? tooltipRBox.width : 150) }\n  // keeps from going over left edge\n  if (xG &lt; 0) { xG = 0 }\n  // keeps from going over bottom\n  if (yG &gt; svgBox.height - tooltipRBox.height) { yG = y - tooltipRBox.height - mouseOffset[1] }\n  // tooltips will always be under top\n  tooltipG.setAttribute('transform', `translate(${xG},${yG})`)\n  tooltipG.style.visibility = 'visible'\n}\n\n\nStyling for the tooltip:\n\nCodeg.borders &gt; path.hover {\n  stroke-width: 0.5 !important;\n  stroke: rgb(226, 226, 226) !important;\n}\ng.tooltip {\n  visibility: hidden;\n}\ng.tooltip rect {\n  fill: rgba(255, 255, 255, 0.7);\n  rx: 2px;\n  ry: 2px;\n}\ng.tooltip text {\n  font-size: 16px;\n  dominant-baseline: middle;\n  text-anchor: middle;\n}\n\n\nThe Whole Game\nCombining all of these techniques involves quite a bit of prototyping. There‚Äôs a lot to pick apart, especially with mapping elements of the ggplot to the svg output correctly. Figure¬†3 displays an outline of the core components of the script. You can dive deep into the full script below. I originally built this to add within the about page/path of my site, so this is why paths are relative to the about/ directory.\nWhen it comes to prototyping CSS/JavaScript, I created 2 methods to add styles and scripts. For testing purposes, I setup the CSS/JavaScript to source external scripts. This allows you to set breakpoints on script files sourced by the SVG in Developer Tools, as well as edit stylesheets natively in the Sources/Styling Editor. For ‚Äòproduction‚Äô, I keep the graphic entirely self-contained, e.g.¬†not sourcing any external scripts. This means that the SVG element can be downloaded and used in any browser context, without the need for the external .css/.js dependencies. Additionally, I embed the external .ttf font as base64 encoded data.\n\nusapop-svg.Rlibrary(sf)\nlibrary(ggfx)\nlibrary(xml2)\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(rvest)\nlibrary(usmap)\nlibrary(tibble)\nlibrary(tictoc)\nlibrary(ggplot2)\nlibrary(svglite)\nlibrary(showtext)\nlibrary(base64enc)\n\ntic()\n\n# data load & format ----\nd &lt;- left_join(usmap::us_map(regions='county'), usmap::countypop, by = c('fips', 'abbr', 'county')) |&gt;\n  as_tibble()\n# must create individual polygons first before entire counties of multiple polygons\nd_sf &lt;- d |&gt; st_as_sf(coords = c('x', 'y'), crs = usmap::usmap_crs()) |&gt; st_transform(4326) |&gt;\n  group_by(group) |&gt;\n  summarise(\n    geometry = st_combine(geometry) |&gt; st_cast('POLYGON'),\n    across(c(abbr, pop_2015, full, county, fips), unique)\n  ) |&gt;\n  group_by(fips) |&gt;\n  summarise(\n    geometry = st_combine(geometry),\n    across(c(abbr, pop_2015, full, county), unique),\n    l_group = list(group)\n  ) |&gt;\n  mutate(pop_full = sum(pop_2015, na.rm = T), .by = full) |&gt;\n  mutate(\n    point = lapply(geometry, function(p) p |&gt; st_cast('POINT') |&gt;\n      suppressWarnings()) |&gt; st_sfc() |&gt; st_set_crs(4326),\n    county = sub(x = county, pattern = ' County', replacement = ''),\n    pop_perc = pop_2015/pop_full\n  ) |&gt;\n  mutate(\n    text = paste0(\n      sprintf(paste0(county, ', ', full, ' ', '%.2f%%'), 100*pop_perc),\n      # for mapping SVG elements\n      '|', lapply(geometry, length) |&gt; unlist()\n    )\n  )\n\n# ggplot ----\n## plot format objects ----\nproj &lt;- '+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs'\nd_sf_us &lt;- d_sf |&gt; filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  summarise(geometry = st_combine(geometry)) |&gt;\n  mutate(geometry = geometry |&gt; st_make_valid() |&gt; st_union()) |&gt;\n  st_transform(proj)\nd_sf_states &lt;- d_sf |&gt; group_by(full) |&gt; summarise(geometry = st_combine(geometry)) |&gt;\n  mutate(geometry = geometry |&gt; st_make_valid() |&gt; st_union(), .by = full) |&gt;\n  filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  st_transform(proj)\nd_sf_plot &lt;- d_sf |&gt;\n  filter(! full %in% c('Hawaii', 'Alaska')) |&gt;\n  st_transform(proj)\n## plot object ----\ng0 &lt;- list(\n  geom_sf(mapping = aes(fill = log(pop_2015)), linewidth=0.1),\n  scale_fill_continuous(low = 'yellow', high = 'darkgreen', na.value='yellow', guide = 'none'),\n  geom_sf(data = d_sf_states, color = \"black\", fill = 'transparent'),\n  geom_sf_text(aes(geometry = point, label = text)),\n  labs(title = 'Population Across America'),\n  theme_void(),\n  theme(\n    text = element_text(family='serif'),\n    plot.title = element_text(vjust = 0.01, hjust = 0.5, size = 55)#size = 75)\n  )\n)\ng &lt;- ggplot(data = d_sf_plot) + g0\ngb &lt;- ggplot_build(g)\ng &lt;- g +\n  annotate(\n    \"text\", label = \"¬© Vincent Clemson\", family='serif', size = 12/.pt,\n    x = gb$layout$panel_params[[1]]$x_range[1]+1100000,\n    y = gb$layout$panel_params[[1]]$y_range[1]+500000,\n  )\n\ngfx &lt;- ggplot(data = d_sf_plot) +\n  with_shadow(\n    sigma = 3, x_offset = 3, y_offset = 3,\n    geom_sf(data = d_sf_us, color = \"black\", fill = 'white')\n  ) +\n  g0\n\n## save ggplot to svg ----\n# must write to file - uses {svglite}\nfonts &lt;- list(serif = list(plain = list(alias = 'Black Chancery Regular', file = 'about/BLKCHCRY.TTF')))\n# mbp 14\" height / width in inches\nwidth &lt;- 11.88212\nheight &lt;- 7.465619\nggsave(plot = g, width = width, height = height, filename = 'about/usapop.svg', user_fonts = fonts)\nggsave(plot = gfx, width = width, height = height, filename = 'about/usapopfx.svg')\n\n# svg editting ----\n## read svg as xml document for editting ----\ndoc &lt;- read_xml('about/usapop.svg')\ndocfx &lt;- read_xml('about/usapopfx.svg')\nns_d1 &lt;- xml_ns(doc) |&gt; as.list() |&gt; pluck('d1')\nxml_ns_strip(doc)\nxml_ns_strip(docfx)\n## gather svg element data & non-dummy data to edit ----\n# then move to new node & remove moved elements\nxn_g &lt;- doc |&gt; html_elements('g') |&gt; pluck(2)\nxn_txt_use &lt;- xn_g |&gt; html_elements('text') |&gt; rev() |&gt; pluck(1)\nxn_img &lt;- docfx |&gt; html_elements('image') |&gt; pluck(1)\ndoc |&gt; html_elements('g') |&gt; pluck(3) |&gt; xml_add_child(xn_txt_use)\ndoc |&gt; html_elements('g') |&gt; pluck(1) |&gt; xml_add_child(xn_img)\nxml_remove(xn_txt_use)\nxn_g_path &lt;- xn_g |&gt; html_elements('path')\nxn_g_txt &lt;- xn_g |&gt; html_elements('text')\n## hover / popup metadata ----\nl_txt &lt;- xn_g_txt |&gt; lapply(function(i) strsplit(html_text(i), '\\\\|') |&gt; unlist())\nxby &lt;- l_txt |&gt; lapply(function(i) pluck(i, 2)) |&gt; unlist() |&gt; as.integer()\ntxt &lt;- l_txt |&gt; lapply(function(i) pluck(i, 1)) |&gt; unlist()\nxby_expand &lt;- lapply(xby, function(x) rep(x, x)) |&gt; unlist()\ntxt_expand &lt;- map2(txt, xby, \\(t, x) rep(t, x)) |&gt; unlist()\nd_key &lt;- tibble(xby_expand, txt_expand) |&gt;\n  mutate(ID = 1:n())\n# identify county paths composed of more than 1 polygon\nidx_1 &lt;- d_key |&gt; filter(xby_expand &gt; 1) |&gt;\n  reframe(ID = ID[1], .by = txt_expand) |&gt; pull(ID)\nfor(i in idx_1) {\n  for (j in 1:(d_key |&gt; filter(ID == i) |&gt; pull(xby_expand) - 1)) {\n    d_at &lt;- xn_g_path[[i]] |&gt; xml_attr('d')\n    xn_g_path[[i]] |&gt; xml_attr('d') &lt;- paste(d_at, xn_g_path[[i+j]] |&gt; xml_attr('d'))\n  }\n}\n## removal of dummy layers ----\nfor(i in idx_1) {\n  for (j in 1:(d_key |&gt; filter(ID == i) |&gt; pull(xby_expand) - 1)) {\n    xml_remove(xn_g_path[i+j])\n  }\n}\nn_before &lt;- length(xn_g_path)\n## create new path list sets with updated nodes ----\nxn_g_path &lt;- xn_g |&gt; html_elements('path')\nn_after &lt;- length(xn_g_path)\nn_removed &lt;- n_before - n_after\nn_tobe &lt;- length(xn_g_txt)\nn_other &lt;- n_before - n_removed - n_tobe\nxn_g_path_1 &lt;- xn_g_path[1:n_tobe]\nxn_g_path_2 &lt;- xn_g_path[(n_tobe+1):(n_after)]\n## combine individual polygons into group ----\n# combines all polygons into same svg path element for counties\nmap2(xn_g_path_1, txt, \\(p, t) xml_attr(p, \"title\") &lt;- t) |&gt; invisible()\nxml_remove(xn_g_txt)\nx_tooltip &lt;- read_xml('&lt;g class=\"tooltip\"&gt;&lt;rect/&gt;&lt;text&gt;&lt;/text&gt;&lt;/g&gt;')\n## add separate layers to separate nodes ----\nxb_g &lt;- read_xml('&lt;g class=\"borders\"&gt;&lt;/g&gt;')\nlapply(xn_g_path_2, function(i) xb_g |&gt; xml_add_child(i)) |&gt; invisible()\nxml_remove(xn_g_path_2)\n## styling / javascript ----\n### gather near equivalent to &lt;head&gt; ----\nx_def &lt;- doc |&gt; html_elements('defs') |&gt; pluck(1)\nxn_g |&gt; xml_attr('class') &lt;- 'choro'\n### css styling ----\nx_style &lt;- x_def |&gt; html_element('style')\nstyle_t &lt;- x_style |&gt; html_text()\nstyle &lt;- readLines('about/usapop.css') |&gt; paste0(collapse = '\\n')\n### fonts ----\nfdata &lt;- readBin(fonts$serif$plain$file, what = \"raw\", n = 1e6)\nstyle_f &lt;- paste0(c(\n  'g.tooltip {',\n  paste0('font-family:', fonts$serif$plain$alias, ';'),\n  '}',\n  '@font-face {',\n  paste0('font-family:', fonts$serif$plain$alias, ';'),\n  paste0('src: url(data:font/ttf;base64,', base64encode(fdata), ') format(\"truetype\");'),\n  '}'\n), collapse = '\\n')\n#### javascript ----\nx_script &lt;- read_xml('&lt;script&gt;&lt;/script&gt;')\nscript &lt;- readLines('about/usapop.js') |&gt; paste0(collapse = '\\n')\n## add all to xml ----\n### uncomment for testing ----\n# x_style_l &lt;- read_xml('&lt;link xmlns=\"http://www.w3.org/1999/xhtml\" rel=\"stylesheet\" href=\"usapop.css\"/&gt;')\n# doc |&gt; xml_add_child(x_style_l, .where = 0)\n# xml_text(x_style) &lt;- paste0(style_t, '\\n', style_f)\n# x_script &lt;- read_xml('&lt;script xlink:href=\"usapop.js\"&gt;&lt;/script&gt;')\n### for production - self-contained ----\nxml_text(x_style) &lt;- paste0(style_t, '\\n', style, '\\n', style_f)\nxml_text(x_script) &lt;- script\ndoc |&gt; xml_add_child(xb_g)\ndoc |&gt; xml_add_child(x_tooltip)\ndoc |&gt; xml_add_child(x_script)\n## output & cleanup ----\n# re-add namespace & fix attribute unit\nxml_attr(doc, 'xmlns') &lt;- ns_d1\n# unset to allow element to take full advantage of viewBox\nxml_attr(doc, 'width') &lt;-  NULL\nxml_attr(doc, 'height') &lt;- NULL\nfile.remove('about/usapopfx.svg')\nwrite_xml(doc, 'about/usapop.svg')\n\ntoc()\n\n\n\n\n\n\n\nFigure¬†3: Outline within RStudio of the US population SVG graphic R script"
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#finished-product",
    "href": "posts/geo/maps-ggplot-svglite/index.html#finished-product",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "Finished Product",
    "text": "Finished Product\nEnjoy the viz!\n\n\n\n\n\n\nFigure¬†4: The ggplot converted to SVG. A choropleth of the population of the continental United States in 2015."
  },
  {
    "objectID": "posts/geo/maps-ggplot-svglite/index.html#wrap-up",
    "href": "posts/geo/maps-ggplot-svglite/index.html#wrap-up",
    "title": "Designing aesthetic maps in R with ggplot2 & svglite",
    "section": "Wrap-up",
    "text": "Wrap-up\nIf you have any thoughts or questions, feel free to let me know what you think in the comments below. You‚Äôll need to sign in to your GitHub account to do so. Like my work? Feel free to reach out.\nWe only have one rock, and it‚Äôs a beautiful one. Thanks for reading! ‚úåÔ∏èüåç"
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "",
    "text": "A split web map of Tafeghaghte, Morocco, displaying pre & post event satellite imagery from Maxar‚Äôs Open Data Program.\n\n\n\n\nFigure¬†1: The village of Tafeghaghte was reduced to utter ruin after the Earthquakes that struck Morocco in the late evening of September 8th, 2023."
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#tldr",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#tldr",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "TLDR",
    "text": "TLDR\nI use some open source geospatial tools to tile satellite imagery on-the-fly from Maxar‚Äôs Open Data Program (ODP). In particular, I use the recent devastating earthquake in Morocco as an example. Figure¬†10 displays a demo of this. You can use Figure¬†9 to play around with the web map for yourself."
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#intro",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#intro",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Intro",
    "text": "Intro\nThe title is a mouthful, so let‚Äôs backup a bit. Being able to create a layer in a web map from new satellite imagery can be beneficial for many reasons. When a natural disaster strikes, collecting this imagery, distributing it, and getting it in front of trained mapping volunteers‚Äô eyes is a critical part of the chain of events for providing up-to-date information for first responders‚Äô efforts on the ground. The Humanitarian OpenStreetMap Team (HOT), is a global non-for-profit organization who is a prime example of connecting & integrating these various efforts into disaster response.\n\n\n\n\n\n\nNote\n\n\n\nHADR (Humanitarian Assistance & Disaster Response/Relief) is a common acronym used by government entities. And it‚Äôs continuing to be explored how breakthroughs in AI can be applied to HADR efforts (e.g.¬†https://hadr.ai).\n\n\nTools like Google Maps and Apple Maps are something that many of us use everyday for directions & navigation. How do they work though? They load what are called map tiles directly to your computer/phone to be displayed in the web map application. The tile data can be broken down into 2 categories, vector and raster. Vector tiles contain geometry and metadata information, like roads, building outlines, and locations. They can be loaded dynamically & efficiently by mapping libraries that ingest the Mapbox vector tile specification. Raster tiles on the other hand are images. And further more web browsers & apps need the images to be stored in a special encoding to be able to render them on the web map, e.g.¬†jpeg, png, or webp format.\nCombinations of raster tiles on a web map can be thought of as a layer. Additionally, specific types of vector tile data can be split into layers as well. Figure¬†2 shows the different layers that can be selected from within Google Maps. The ‚ÄúTraffic‚Äù layer is a vector layer, whereas the ‚ÄúSatellite‚Äù layer is a raster layer made up of mosaiced satellite imagery.\n\n\n\n\n\n\nFigure¬†2: Layers as displayed in Google Maps\n\n\n\nThe methods used to create and serve raster tiles to a web map can be broken down into static and dynamic tiling techniques. The reason why providers like Google, Apple, and Bing can stream these map layers so quickly to us is that they use a static tiling technique that uses prerendered images stored on their servers. The images at each level of the slippy map are combinations of several optical imagery resolutions from multiple commercial & government satellite providers, which is why you can see the attribution level in the bottom of the map change as you zoom to different levels and pan over different areas of the Earth. Figure¬†3 displays an example of this.\n\n\n\n\n\n\nFigure¬†3: Attribution of the Satellite layer as displayed in Google Maps\n\n\n\nEarth observation satellites range in their spatial resolution capabilities. The service providers of basemaps used within the aforementioned mapping tools use techniques to both mosaic & tile the optical imagery. As zoom levels of the web map increase, higher resolutions of the imagery can be streamed to the web map. Additionally, imagery is updated strategically by the companies that host it, and a mixture of satellite imagery is used overtime to capture the entire world from different satellite look angles. Thus, it‚Äôs difficult to capture the temporal component of common basemaps.\nFigure¬†4 displays a screenshot from Google Earth over Tafeghaghte, Morocco. This area is currently devastated due to the 6.8 magnitude Earthquake that struck the Marrakesh region. However, the mosaic layer of raster tiles shown here appear to be of pre-event imagery. It is zoomed in enough to a level where a date range is given for the imagery displayed. Here, the range is from the end of December 2022 to ‚Äúnewer‚Äù. Credit to the NY Times on their Morocco Earthquake article & to Airbus for identifying, analyzing & displaying the location.\n\n\n\n\n\n\nFigure¬†4: Pre-event Google Earth screen capture of Tafeghaghte, Morocco. Date range displayed at bottom. Source.\n\n\n\n\n\n\n\n\n\nNote\n\n\n\nSince the original undertaking of writing this post, Google Earth & Google Maps have both updated their web maps to reflect post Earthquake satellite imagery for this location. Figure¬†5 captures this.\n\n\n\n\n\n\n\n\nFigure¬†5: Post-event updated Google Earth screen capture of Tafeghaghte, Morocco. Updated sometime after 09/16/23. Source.\n\n\n\nCOG (Cloud Optimized GeoTIFF) formatted imagery was created to easily send images over the web. Through the use of dynamic tiling servers like TiTiler, we can create mosaic layers of satellite imagery. For responding to natural disasters, combining these technologies with government & commercial imagery provider releases like Maxar‚Äôs Open Data Program (ODP for short) can help to create tools that are useful for skilled mappers.\n\n\n\n\n\n\nmosaicJSON specification visual\n\n\n\n\nFigure¬†6: Source: developmentseed/mosaicjson-spec GitHub\n\n\n\nQiusheng Wu‚Äôs incredible tool Leafmap was designed for applications just like this. Leafmap can add mosaiced imagery as layers to the web map by pointing a TiTiler endpoint to a mosaicJSON file. By default, Leafmap utilizes Development Seed‚Äôs TiTiler demo endpoint at https://titiler.xyz to do this. New mosaicJSON files for collections of satellite imagery can easily be created from a STAC (SpatioTemporal Asset Catalog), such as those within the opengeos/maxar-open-data project repo, or directly from the Maxar Open Data STAC. Figure¬†6 shows a logical visual representation of the specification JSON structure."
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#reading-processing-stac-data",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#reading-processing-stac-data",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Reading & Processing STAC Data",
    "text": "Reading & Processing STAC Data\nFortunately, Qiusheng Wu has created a repo to store the Maxar Open Data STAC in opengeos/maxar-open-data, as well as an ETL to continue to processes the data automatically using GitHub Actions. Once a day, the action looks for new events in the STAC, as well as makes updates to existing event datasets. This ETL stores information on each event as well as on each ARD Visual Tile (Analysis-Ready Data). Currently, there are .tsv files that store a row describing each ARD visual COG in the STAC. Additionally, there are .geojson files that show the footprints of each image. These are broken into multiple categories. At a micro-level, there are per image GeoJSONs, broken into 2 categories: by tile, i.e.¬†quadkey, and the union of all tiles, e.g.¬†the image footprint. A single image, and therefore an image footprint, correlates to an acquisition ID (also referred to as a catalog ID).\n Morocco Earthquake example for acquisition ID 10300100ED11EA00:This image footprint covers the town of Amizmiz as well as the village of Tafeghaghte.\n\nBy Image Footprint\n\nhttps://github.com/opengeos/maxar-open-data/blob/master/datasets/Morocco-Earthquake-Sept-2023/10300100ED11EA00_union.geojson\n\nBy Tile\n\nhttps://github.com/opengeos/maxar-open-data/blob/master/datasets/Morocco-Earthquake-Sept-2023/10300100ED11EA00.geojson\n\n\nAt a macro-level, for each event, there are GeoJSONs stored as well, one containing individual tiles and another containing each image footprint.\nMorocco Earthquake example:\n\nBy Image Footprint\n\nhttps://github.com/opengeos/maxar-open-data/blob/master/datasets/Morocco-Earthquake-Sept-2023_union.geojson\n\nBy Tile\n\nhttps://github.com/opengeos/maxar-open-data/blob/master/datasets/Morocco-Earthquake-Sept-2023.geojson\n\n\nFigure¬†7 displays all of these examples in one place as 4 separate layers on a map.\nYou can find the ETL script for updating the datasets here. At the rate that Qiusheng adds new features to his tools, I‚Äôm sure there will be updates made to this repo in the near future.\n\n\nMorocco Earthquake Leafmap Folium Widget for Event & Acquisition Tile/Footprint Vector Layers\nimport leafmap\nimport leafmap.foliumap\nfrom leafmap2 import add_geojson2\nleafmap.foliumap.Map.add_geojson2 = add_geojson2\n\n# per event\nf_e_tile = \"https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/Morocco-Earthquake-Sept-2023.geojson\"\nf_e_img = \"https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/Morocco-Earthquake-Sept-2023_union.geojson\"\n# per acquisition\nf_i_tile = \"https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/Morocco-Earthquake-Sept-2023/10300100ED11EA00.geojson\"\nf_i_img = \"https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/Morocco-Earthquake-Sept-2023/10300100ED11EA00_union.geojson\"\n\nm = leafmap.foliumap.Map()\n\nm.add_geojson2(\n    f_e_tile, \"Event Layer - Tiles\", style={'color': 'blue'}, info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_geojson2(\n    f_e_img, \"Event Layer - Image Footprints\", style={'color': 'green'}, info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_geojson2(\n    f_i_tile, \"Acquisition Layer - Tiles\", style={'color': 'purple'}, info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_geojson2(\n    f_i_img, \"Acquisition Layer - Image Footprint\", style={'color': 'red'}, info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\n\nwith open('./popup-fix.js') as f: js = f.read()\n# must render 1st to add script after - otherwise adds JS before Leaflet L.Map assignment\nm.get_root().render()\n# add map & geojson layer variables to script\nvar_map = m.get_name()\nvar_geojson_lgs = str([i for i in m._children.keys() if re.search('^geo_json_', i) is not None]).replace(\"'\", \"\")\nm.get_root().script.add_child(Element(js.format(m=var_map, lg_geo=var_geojson_lgs)))\nm.fit_bounds(m.get_bounds())\n\n\n\n\n\n\n\n\n\nFigure¬†7: Event & Acquisition Tile & Footprint Imagery Vector Layers of the Morocco Earthquake. Sources: opengeos/maxar-open-data Github & Maxar Open Data Program STAC"
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#before-after---capturing-pre-post-events",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#before-after---capturing-pre-post-events",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Before & After - Capturing Pre & Post Events",
    "text": "Before & After - Capturing Pre & Post Events\nNatural disasters evolve rapidly, yet vary in nature. As their effects unfold, they can linger & ripple. Thus, it‚Äôs challenging to define clear cut before & after timelines. In Maxar‚Äôs white paper describing their open data disaster response protocol, they describe that their data will include both pre & post event imagery. In attempt to make distinctions here that assist first responders, it may be helpful to first capture the event in a way that defines pre & post events, and then continue to evolve as both the disaster and response to the disaster unfolds. On the Open Data Program website, each event date is posted, and each event is indeed broken into pre & post event datasets. However, within the STAC, there is no metadata field defining the date of the event, and neither is there a pre & post event metadata field, just acquisition dates of the imagery.\nComputer vision models that use satellite imagery to perform classification in attempt to predict the amount of damage of detected objects and/or damage over an area can only be so accurate & precise. Yet, these are promising techniques and are continuing to evolve as viable response methods.\nAs a first order analysis, we can utilize historical information on the event to define pre & post event imagery. From there, we can attempt to make web maps more interactive for responders. These features can and are being experimented with. Additionally, as more providers respond to events by releasing their imagery through open access programs, the techniques can evolve in attempt to provide a collection of the best imagery to meet responders‚Äô unique, niche needs.\nWe‚Äôll first download and store the data for all events. Then, we‚Äôll can use our Morocco event as an example moving forward.\nI think that all of the anti-patterns associated with Pandas make it kind of a suboptimal dataframe/analysis library.However, I use it here due to its integration with Geopandas & Leafmap. For the Python geospatial ecosystem, I am really looking forward to Geopolars taking off in 2024.\n\n\nEvents in Maxar‚Äôs Open Data Program\nimport numpy as np\nimport pandas as pd\nimport geopandas as gpd\n\np_datasets = 'https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets.csv'\nd_maxar = pd.read_csv(p_datasets)\np_top = 'https://raw.githubusercontent.com/opengeos/maxar-open-data/master/datasets/'\np_bottom = '.geojson'\n\nd_maxar['dataset']\n\n\n0            BayofBengal-Cyclone-Mocha-May-23\n1         Emilia-Romagna-Italy-flooding-may23\n2                   Gambia-flooding-8-11-2022\n3                   Hurricane-Fiona-9-19-2022\n4                     Hurricane-Ian-9-26-2022\n5              Hurricane-Idalia-Florida-Aug23\n6                      Indonesia-Earthquake22\n7          Kahramanmaras-turkey-earthquake-23\n8                  Kalehe-DRC-Flooding-5-8-23\n9                      Libya-Floods-Sept-2023\n10                    Marshall-Fire-21-Update\n11                   Maui-Hawaii-fires-Aug-23\n12    McDougallCreekWildfire-BC-Canada-Aug-23\n13               Morocco-Earthquake-Sept-2023\n14                          NWT-Canada-Aug-23\n15                     New-Zealand-Flooding22\n16                     New-Zealand-Flooding23\n17                   Sudan-flooding-8-22-2022\n18                   afghanistan-earthquake22\n19                           cyclone-emnati22\n20                          ghana-explosion22\n21                kentucky-flooding-7-29-2022\n22                        pakistan-flooding22\n23             shovi-georgia-landslide-8Aug23\n24                     southafrica-flooding22\n25                            tonga-volcano21\n26                        volcano-indonesia21\n27                     yellowstone-flooding22\nName: dataset, dtype: object\n\n\nWe can store these datasets into a single dataframe. And we can also compare this collection to the current STAC deployed at https://maxar-opendata.s3.amazonaws.com/events/catalog.json.\n\n\nTile Dataframe of Maxar ODP\n%%time\n\nl_gdf = [gpd.read_file(p_top+d+p_bottom).assign(event = d) for d in d_maxar['dataset'].to_list()]\n\nd_tiles = (pd.concat(l_gdf, ignore_index=True))\n# changes column order - puts event & geometry first\nd_tiles = d_tiles[d_tiles.columns[-2::][::-1].append(d_tiles.columns[:-2])]\n\n\nCPU times: user 5.37 s, sys: 325 ms, total: 5.69 s\nWall time: 15.5 s\n\n\n\n\nMaxar ODP Event STAC Query\n%%time \n\nfrom pystac import Catalog\n\nhref = \"https://maxar-opendata.s3.amazonaws.com/events/catalog.json\"\nroot_catalog = Catalog.from_file(href)\ncollection_events = list(root_catalog.get_collections())\n\n\nCPU times: user 935 ms, sys: 98.7 ms, total: 1.03 s\nWall time: 11.5 s\n\n\n\n\nEvents in both ODP STAC & opengeos/maxar-open-data\nid_events = [c.id for c in collection_events]\nid_events\n\n\n['BayofBengal-Cyclone-Mocha-May-23',\n 'Emilia-Romagna-Italy-flooding-may23',\n 'Gambia-flooding-8-11-2022',\n 'Hurricane-Fiona-9-19-2022',\n 'Hurricane-Ian-9-26-2022',\n 'Hurricane-Idalia-Florida-Aug23',\n 'Indonesia-Earthquake22',\n 'Kahramanmaras-turkey-earthquake-23',\n 'Kalehe-DRC-Flooding-5-8-23',\n 'Libya-Floods-Sept-2023',\n 'Marshall-Fire-21-Update',\n 'Maui-Hawaii-fires-Aug-23',\n 'McDougallCreekWildfire-BC-Canada-Aug-23',\n 'Morocco-Earthquake-Sept-2023',\n 'NWT-Canada-Aug-23',\n 'New-Zealand-Flooding23',\n 'Sudan-flooding-8-22-2022',\n 'afghanistan-earthquake22',\n 'cyclone-emnati22',\n 'ghana-explosion22',\n 'kentucky-flooding-7-29-2022',\n 'pakistan-flooding22',\n 'shovi-georgia-landslide-8Aug23',\n 'southafrica-flooding22',\n 'tonga-volcano21',\n 'volcano-indonesia21',\n 'yellowstone-flooding22']\n\n\nHere, we assign every event time a start date and site our sources. If there is leeway to the exact event time, we assign the day that it has been reported and offset to the beginning of the day for the UTC timezone. Then, we add the event data to our tile dataframe & easily save it to geojson for pre/post event analysis later.\n\n\nEvent Data\ndict_event = {\n    'BayofBengal-Cyclone-Mocha-May-23': ['2023-05-13 18:30:00', 'https://www.maxar.com/open-data/bay-of-bengal-cyclone-mocha-2023'],\n    'Emilia-Romagna-Italy-flooding-may23': ['2023-05-01 22:00:00', 'https://en.wikipedia.org/wiki/2023_Emilia-Romagna_floods'],\n    'Gambia-flooding-8-11-2022': ['2022-08-11 00:00:00', 'https://www.maxar.com/open-data/the-gambia-flooding'],\n    'Hurricane-Fiona-9-19-2022': ['2022-09-18 04:00:00', 'https://www.maxar.com/open-data/hurricane-fiona'],\n    'Hurricane-Ian-9-26-2022': ['2022-09-27 08:30:00', 'https://www.nhc.noaa.gov/data/tcr/AL092022_Ian.pdf'],\n    'Hurricane-Idalia-Florida-Aug23': ['2023-08-30 05:00:00', 'https://www.maxar.com/open-data/hurricane-idalia-florida'],\n    'Indonesia-Earthquake22': ['2022-11-21 06:21:07', 'https://earthquake.usgs.gov/earthquakes/eventpage/us7000ir9t/executive'],\n    'Kahramanmaras-turkey-earthquake-23': ['2023-02-06 01:17:34', 'https://earthquake.usgs.gov/earthquakes/eventpage/us6000jllz/executive'],\n    'Kalehe-DRC-Flooding-5-8-23': ['2023-05-07 22:00:00', 'https://www.maxar.com/open-data/kalehe-drc-flooding-2023'],\n    'Libya-Floods-Sept-2023': ['2023-09-10 23:00:00', 'https://www.cnn.com/2023/09/14/middleeast/lethal-factors-leading-to-libya-floods-intl/index.html'],\n    'Marshall-Fire-21-Update': ['2021-12-30 06:00:00', 'https://www.maxar.com/open-data/marshall-fire21'],\n    'Maui-Hawaii-fires-Aug-23': ['2023-08-09 01:00:00', 'https://firms.modaps.eosdis.nasa.gov/usfs/'],\n    'McDougallCreekWildfire-BC-Canada-Aug-23': ['2023-08-15 12:59:00', 'https://en.wikipedia.org/wiki/McDougall_Creek_Fire'],\n    'Morocco-Earthquake-Sept-2023': ['2023-09-08 22:11:01', 'https://earthquake.usgs.gov/earthquakes/eventpage/us7000kufc/executive'],\n    'NWT-Canada-Aug-23': ['2023-08-16 07:00:00', 'https://www.maxar.com/open-data/nwt-canada-fires'],\n    'New-Zealand-Flooding23': ['2023-01-26 12:00:00', 'https://www.maxar.com/open-data/new-zealand-flooding23'],\n    'Sudan-flooding-8-22-2022': ['2022-08-21 22:00:00', 'https://www.maxar.com/open-data/sudan-flooding-22'],\n    'afghanistan-earthquake22': ['2022-06-21 20:54:34', 'https://earthquake.usgs.gov/earthquakes/eventpage/us7000hj3u/executive'],\n    'cyclone-emnati22': ['2022-02-21 21:00:00', 'https://www.maxar.com/open-data/cyclone-emnati'],\n    'ghana-explosion22': ['2022-01-20 15:00:00', 'https://abcnews.go.com/International/massive-explosion-rocks-town-ghana/story?id=82375601'],\n    'kentucky-flooding-7-29-2022': ['2022-07-29 05:00:00', 'https://www.maxar.com/open-data/kentucky-flooding22'],\n    'pakistan-flooding22': ['2022-07-25 17:00:00', 'https://www.maxar.com/open-data/pakistan-flooding22'],\n    'shovi-georgia-landslide-8Aug23': ['2022-08-03 11:00:00', 'https://civil.ge/archives/554327'],\n    'southafrica-flooding22': ['2022-04-12 22:00:00', 'https://www.maxar.com/open-data/southafrica-flooding22'],\n    'tonga-volcano21': ['2022-01-13 15:20:00', 'https://wikipedia.org/wiki/2022_Hunga_Tonga%E2%80%93Hunga_Ha%CA%BBapai_eruption_and_tsunami'],\n    'volcano-indonesia21': ['2021-12-04 07:50:00', 'https://reliefweb.int/report/indonesia/indonesia-mount-semeru-eruption-operation-final-report-dref-operation-ndeg-mdrid023'],\n    'yellowstone-flooding22': ['2022-06-15 06:00:00', 'https://www.maxar.com/open-data/yellowstone-flooding22']\n}\n\nd_event = pd.DataFrame.from_dict(dict_event, orient='index', columns=['t_event', 'source'])\nd_event = (d_event\n .reset_index(names='event')\n .assign(t_event = pd.to_datetime(d_event.t_event, utc=True).to_list())\n .sort_values('t_event', ascending=False)\n .reset_index(drop=True)\n)\n\n\n\n\nTile Dataframe of Maxar ODP w/ Event Data\n# right join removes old datasets stored in opengeos/maxar-open-data\nd_tiles = pd.merge(left=d_tiles, right=d_event, how='right', left_on='event', right_on='event')\nd_tiles = d_tiles.assign(pre_post = np.where(d_tiles.datetime &lt; d_tiles.t_event, 'pre', 'post'))\nd_tiles.insert(1, 'pre_post', d_tiles.pop('pre_post'))\n# sort by latest event date \nd_tiles = (d_tiles\n .assign(latest = d_tiles.groupby('event')['t_event'].transform('max'))\n .sort_values(['latest','datetime'], ascending=False)\n .drop('latest', axis=1)\n .reset_index(drop=True)\n)\nd_tiles.to_file('maxar_odp_tiles.geojson')"
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#building-mosaics",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#building-mosaics",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Building Mosaics",
    "text": "Building Mosaics\nHere, I build the mosaicJSON specification files. After creation, I store them on my GitHub at prncevince/mosaicjson-examples. To allow Development Seed‚Äôs TiTiler demo endpoint to run a GET request on the mosaicJSON, they must be accessible from the web. Later, we can use https://raw.githubusercontent.com as the base domain for the TiTiler endpoint to read the mosaicJSON files.\n\n\n\n\n\n\nImportant\n\n\n\nThis may not be the most efficient way to generate the mosaicJSON. The below snippet took ~6.5 hours to run on a MBP M1 Pro with 10 CPU cores & 32 GB of RAM. Also, due to previous logic, it failed the first time around due to attempting to create mosaicJSON files using 0 images (e.g.¬†for events that have just pre or just post event imagery, but not both). However, strategically experimenting with parallelism can help improve the speed of mosaicJSON creation as pointed out in this discussion.\n\n\n\n\nPre & Post Event MosaicJSON Creation\n%%time\nimport os\nimport time\nfrom cogeo_mosaic.mosaic import MosaicJSON\nfrom cogeo_mosaic.backends import MosaicBackend\n\nfor e in np.unique(d_tiles.event)[10:]:\n    start = time.time()\n    d = d_tiles[d_tiles.event == e].reset_index(drop=True)\n    # write output\n    os.makedirs('data/'+e, exist_ok=True)\n    for i in ['pre', 'post']:\n        images = d[d.pre_post == i].reset_index(drop=True).visual.tolist()\n        if len(images) &gt; 0:\n            mosaic = MosaicJSON.from_urls(images)\n            with MosaicBackend('data/'+e+'/mosaic-tiles-'+i+'.json', mosaic_def=mosaic) as f:\n                f.write(overwrite=True)\n    end = time.time()\n    print(e+' Pre/Post MosaicJSON Time: '+str(round(end-start, 2))+'s')\n\n\nMarshall-Fire-21-Update Pre/Post MosaicJSON Time: 10.01s\nMaui-Hawaii-fires-Aug-23 Pre/Post MosaicJSON Time: 83.72s\nMcDougallCreekWildfire-BC-Canada-Aug-23 Pre/Post MosaicJSON Time: 36.84s\nMorocco-Earthquake-Sept-2023 Pre/Post MosaicJSON Time: 8794.56s\nNWT-Canada-Aug-23 Pre/Post MosaicJSON Time: 72.81s\nNew-Zealand-Flooding23 Pre/Post MosaicJSON Time: 47.13s\nSudan-flooding-8-22-2022 Pre/Post MosaicJSON Time: 84.21s\nafghanistan-earthquake22 Pre/Post MosaicJSON Time: 381.16s\ncyclone-emnati22 Pre/Post MosaicJSON Time: 679.6s\nghana-explosion22 Pre/Post MosaicJSON Time: 189.09s\nkentucky-flooding-7-29-2022 Pre/Post MosaicJSON Time: 232.91s\npakistan-flooding22 Pre/Post MosaicJSON Time: 2669.68s\nshovi-georgia-landslide-8Aug23 Pre/Post MosaicJSON Time: 23.75s\nsouthafrica-flooding22 Pre/Post MosaicJSON Time: 813.63s\ntonga-volcano21 Pre/Post MosaicJSON Time: 291.19s\nvolcano-indonesia21 Pre/Post MosaicJSON Time: 241.28s\nyellowstone-flooding22 Pre/Post MosaicJSON Time: 281.45s\nCPU times: user 9min 58s, sys: 6min 55s, total: 16min 53s\nWall time: 4h 8min 53s\n\n\nCURL error: Could not resolve host: maxar-opendata.s3.amazonaws.com\nHTTP response code: 500\nHTTP response code: 404\nHTTP response code: 404"
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#visualizing-pre-post-events",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#visualizing-pre-post-events",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Visualizing Pre & Post Events",
    "text": "Visualizing Pre & Post Events\nFigure¬†8 shows pre & post event layers for all of the image footprints in the ODP. The red layer is pre event footprints & the blue layer is post event. Here, I strategically aggregate the metadata of the tiles by the acquisition/catalog ID field to create a richer per image dataset. We‚Äôre working our way backwards here from tile to image footprint because each item in the STAC is a tile with metadata stored on it. Similar to our tile dataframe, we can store the result as a GeoJSON for later usage.\nMoving along with our Morocco example, Figure¬†9 shows the power of dynamic tiling to investigate the pre/post event imagery. Here, I create a dual split map to help make comparisons of the pre/post event imagery. I also dive deeper into the usage of the split map with a small demo screen recording.\n\n\nImage Footprint Aggregation\n# We need to group by `catalog_id` | then take the union to get image footprint\n# these columns are unique to the tile - thus - they should be handled differently than simply taking the 1st value\n# visual - change to collection url\n# tile:data_area - get this from the footprint union area due to tile overlap\n# tile:clouds_area - sum - decently close\n# tile:clouds_percent   - mean - decently close\n# view:* - mean\n# gsd - mean\ncols_tile = [\n    'visual', 'tile:data_area', 'tile:clouds_area', 'tile:clouds_percent',\n    'view:off_nadir', 'view:azimuth', 'view:incidence_angle', 'view:sun_azimuth', 'view:sun_elevation',\n    'gsd', 'proj:bbox', 'quadkey', 'utm_zone', 'grid:code'\n]\n# create bounding box from image footprint instead of these\ncols_drop = ['proj:bbox', 'quadkey', 'grid:code']\n\ncols_tile_unique = ['utm_zone', 'tile:clouds_area']\ncols_tile_mean = ['gsd', 'tile:clouds_percent', 'view:off_nadir', 'view:azimuth', 'view:incidence_angle', 'view:sun_azimuth', 'view:sun_elevation']\ncols_tile_footprint = ['event', 'pre_post', 'catalog_id']\n\nd_agg = (d_tiles[cols_tile_footprint+cols_tile_unique]\n .groupby(cols_tile_footprint)\n .agg({\n     'utm_zone': lambda x: np.unique(x).tolist(),\n     'tile:clouds_area': lambda x: round(sum(x), 2),\n })\n)\nd_agg_mean = (d_tiles[cols_tile_footprint+cols_tile_mean]\n .groupby(cols_tile_footprint)\n .agg(lambda x: round(np.mean(x), 2))\n)\n\nd_foot = (d_tiles[d_tiles.columns.difference(cols_drop+cols_tile_unique+cols_tile_mean).to_list()]\n .dissolve(cols_tile_footprint, aggfunc = 'first')\n # same index - can left join aggregates on index by default\n .join(d_agg).join(d_agg_mean)\n # add index back to dataframe\n .reset_index()\n)\n# split because `d` carries from original when chaining\nd_foot = (d_foot\n .assign(\n     # uses equal area projection - converts km^2 original units \n     footprint_data_area = lambda d: round(d.geometry.to_crs(epsg=6933).area/1e6, 2),\n     bbox = d_foot.geometry.bounds.applymap(lambda x: round(np.mean(x), 2)).values.tolist()\n )\n .sort_values(['t_event', 'datetime'], ascending=False)\n .reset_index(drop=True)\n .rename(columns={\n     'tile:clouds_area': 'footprint:clouds_area', 'tile:clouds_percent': 'footprint:clouds_percent',\n     'footprint_data_area': 'footprint:data_area'\n })\n)\n\n# `to_file` does not suport list columns - thus `to_json` approach\ndef write_geojson(d, path):\n    with open(path, 'w') as f:\n        # type Timestamp objects with datetime64 dtype must be converted to string\n        for col in d.columns:\n            if d[col].dtype in [\"datetime64[ns]\", \"datetime64[ns, UTC]\"]:\n                d[col] = d[col].astype(str)\n        f.write(d_foot.to_json())\nwrite_geojson(d_foot, 'maxar_odp_footprint.geojson')\n\n\n\n\nLeafmap Folium Widget for Pre & Post Event Image Footprints\nimport re\nfrom folium import Element\nfrom leafmap2 import add_gdf2\nleafmap.foliumap.Map.add_gdf2 = add_gdf2\n\ncols_drop = ['source', 'proj:epsg', 't_event']\nd = d_foot.copy(deep=True)\nd.drop(cols_drop, axis=1, inplace=True)\n\ndef style_footprints(color, fillOpacity, weight):\n    style = {\n        'color': color, 'fillOpacity': fillOpacity, 'weight': weight\n    }\n    return style\n\n# setting `zoom_start=2` has no effect here\nm = leafmap.foliumap.Map(zoom_start=2, world_copy_jump=True) \nm.add_gdf2(\n    d[d.pre_post == 'pre'], \"Pre Event - Image Footprints\",\n    style=style_footprints('blue', 0, 1.5), info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_gdf2(\n    d[d.pre_post == 'post'], \"Post Event - Image Footprints\",\n    style=style_footprints('red', 0, 1.5), info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nwith open('./popup-fix.js') as f: js = f.read()\n# must render 1st to add script after - otherwise adds JS before Leaflet L.Map assignment\nm.get_root().render()\n# add map & geojson layer variables to script\nvar_map = m.get_name()\nvar_geojson_lgs = str([i for i in m._children.keys() if re.search('^geo_json_', i) is not None]).replace(\"'\", \"\")\nm.get_root().script.add_child(Element(js.format(m=var_map, lg_geo=var_geojson_lgs)))\nm.zoom_to_bounds([-105.0, -66.51326044311186, 75, 66.51326044311186])\n\n\n\n\n\n\n\n\n\nFigure¬†8: Pre & Post Event Image Footprints of Maxar ODP Events. Sources: opengeos/maxar-open-data Github & Maxar Open Data Program STAC\n\n\n\n\n\nMorocco Earthquake Pre/Post Event Dynamic Tiling\nFigure¬†9 is a side-by-side comparison map (aka ‚Äúsplit map‚Äù) of the Morocco Earthquake ODP imagery. In this example, I assign single tile layers to both the left & right side of the split map:\n\non the left our dynamically generated tiles of post-event (earthquake) Maxar ODP imagery\non the right Google Satellite xyz tile imagery\n\nThe pre-event imagery is added as well. By default, I‚Äôve toggled on the post-event footprints & toggled off the pre-event footprints. To view the dynamically tiled pre/post event imagery, you need to zoom in and allow Leaflet/TiTiler to do their thing. At the cost of speed, dynamic tiling takes longer for the tiles to be viewed/loaded in the web map because they are generated ‚Äúon-the-fly‚Äù. The TiTiler Dynamic Tiling User Guide explains static vs.¬†dynamic tiling.\nOne thing that I find helpful about the Leafmap widget is that you can search for a longitude/latitude point on the map using the search widget  (magnifying glass). Thus, continuing with Tafeghaghte as an example, in Figure¬†1 as well as my video demo (Figure¬†10) I show how to use this feature to quickly compare before & after images on the map.\nWe could also compare the pre-event imagery provided by the ODP to the post-event imagery. Table¬†1 shows us that there‚Äôs way more pre event than post event imagery available. Additionally, we see that the pre-event Morocco Earthquake imagery comprises a significant portion of the ODP catalog, 36% of the images! I also provide Table¬†2 to show all of the image counts for pre/post events within ODP.\nUnfortunately, the side-by-side split map Leaflet.js plugin has some buggy logic. So right now, it‚Äôs a bit difficult to add any amount of Leaflet layers (an array) to the left & right sides of the map & toggle them on/off as necessary. However, with a more dynamic server sided web app, we can begin to visualize and compare all of this imagery for any event.\n\n\nCode\n100*round(d['count'][1]/d_foot.shape[0], 3)\n\n\n36.0\n\n\n\n\nCode\nd = pd.DataFrame(\n#  (d_tiles\n  (d_foot\n  .groupby(['event', 'pre_post'])\n  ).size(),\n  columns=['count']\n).reset_index()\nd = (d[d.event == 'Morocco-Earthquake-Sept-2023']\n .reset_index(drop=True)\n)\nd.style.hide(axis=\"index\")\n\n\n\n\nTable¬†1: Maxar‚Äôs ODP Morocco Earthquake Event Pre/Post Image Counts\n\n\n\n\n\n\n\n\nevent\npre_post\ncount\n\n\n\n\nMorocco-Earthquake-Sept-2023\npost\n12\n\n\nMorocco-Earthquake-Sept-2023\npre\n226\n\n\n\n\n\n\n\n\n\n\nSplit Map Leamap Folium Widget of Morocco Earthquake\n# 'p' for path | 'm' for mosaic | 'f' for footprint\nevent = 'Morocco-Earthquake-Sept-2023'\npm_top = 'https://raw.githubusercontent.com/prncevince/mosaicjson-examples/main/maxar-open-data/'\npm_end_pre = '/mosaic-tiles-pre.json'\npm_end_post = '/mosaic-tiles-post.json'\n\ncols_drop = ['source', 'proj:epsg', 't_event']\nd = d_foot[d_foot.event == event]\nd.drop(cols_drop, axis=1, inplace=True)\n\nm = leafmap.foliumap.Map()\ndef style_footprints(color, fillOpacity, weight):\n    style = {\n        'color': color, 'fillOpacity': fillOpacity, 'weight': weight\n    }\n    return style\nbasemap = {  \n  \"url\": \"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}\",\n  \"attribution\": \"Google\",\n  \"name\": \"Google Satellite\",\n}\nm.add_tile_layer(**basemap, shown=True)\nm.add_stac_layer(pm_top+event+pm_end_pre, name=\"Pre-Event - Mosaic\", attribution=\"Maxar Technologies\", shown=True)\nm.add_stac_layer(pm_top+event+pm_end_post, name=\"Post-Event - Mosaic\", attribution=\"Maxar Technologies\")\nm.add_gdf2(\n    d[d.pre_post == 'pre'], \"Pre Event - Image Footprints\",\n    style=style_footprints('blue', 0, 1.5), info_mode='both', show=False,\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nm.add_gdf2(\n    d[d.pre_post == 'post'], \"Post Event - Image Footprints\",\n    style=style_footprints('red', 0, 1.5), info_mode='both',\n    tooltip_fields_remove=['visual'], kwargs_tooltip={'sticky': False}\n)\nwith open('./popup-fix.js') as f: js_po = f.read()\nwith open('./side-by-side.js') as f: js_sbs = f.read()\nwith open('./split-map-layout.css') as f: css_sbs_l = f.read()\nwith open('./split-map-range.css') as f: css_sbs_r = f.read()\n#with open('./split-map.js') as f: js_sm = f.read()\n# must render 1st to add script after - otherwise adds JS before Leaflet L.Map assignment\nm.get_root().render()\n# add map & geojson layer variables to script\nvar_map = m.get_name()\nvar_geojson_lgs = str([i for i in m._children.keys() if re.search('^geo_json_', i) is not None]).replace(\"'\", \"\")\ntile_layers = [i for i in m._children.keys() if re.search('^tile_layer_', i) is not None]\n# need to know the order of your tiles for adding as split map\n# an area of multiple layers can be passed to left & right arguments of L.control.sideBySide\n# however, it's pretty buggy when passing more than one layer\ni_all = [0,1,2] # a basemap, pre, & post event\ni_left = [2]\ni_right = [0]\nl_lleft = str([j for i, j in enumerate(tile_layers) if i in i_left]).replace(\"'\", \"\")\nl_lright = str([j for i, j in enumerate(tile_layers) if i in i_right]).replace(\"'\", \"\")\nm.get_root().header.add_child(Element('&lt;style&gt;'+css_sbs_l+'&lt;/style&gt;'))\nm.get_root().header.add_child(Element('&lt;style&gt;'+css_sbs_r+'&lt;/style&gt;'))\nm.get_root().script.add_child(Element(js_po.format(m=var_map, lg_geo=var_geojson_lgs)))\nm.get_root().script.add_child(Element(js_sbs))\nm.get_root().script.add_child(Element('L.control.sideBySide({l_lleft}, {l_lright}).addTo({m});'.format(l_lleft=l_lleft, l_lright=l_lright, m=var_map)))\n\n\n\n\n\n\n\n\n\nFigure¬†9: Split map of Pre/Post Event Imagery after the Morocco Earthquake. Sources: opengeos/maxar-open-data Github & Maxar Open Data Program STAC\n\n\n\n\n\n\nCode\n(pd.DataFrame(\n  (d_foot\n   .assign(t_event = pd.to_datetime(d_foot.t_event).dt.tz_localize(None))\n   .groupby(['t_event', 'event', 'pre_post'])\n  ).size(),\n  columns=['count']\n).sort_values(['t_event'], ascending=False)\n).reset_index().style.hide(axis=\"index\")\n\n\n\n\nTable¬†2: Maxar‚Äôs ODP Event Pre/Post Image Counts\n\n\n\n\n\n\n\n\nt_event\nevent\npre_post\ncount\n\n\n\n\n2023-09-10 23:00:00\nLibya-Floods-Sept-2023\npre\n4\n\n\n2023-09-10 23:00:00\nLibya-Floods-Sept-2023\npost\n3\n\n\n2023-09-08 22:11:01\nMorocco-Earthquake-Sept-2023\npre\n226\n\n\n2023-09-08 22:11:01\nMorocco-Earthquake-Sept-2023\npost\n12\n\n\n2023-08-30 05:00:00\nHurricane-Idalia-Florida-Aug23\npre\n13\n\n\n2023-08-30 05:00:00\nHurricane-Idalia-Florida-Aug23\npost\n1\n\n\n2023-08-16 07:00:00\nNWT-Canada-Aug-23\npre\n2\n\n\n2023-08-16 07:00:00\nNWT-Canada-Aug-23\npost\n2\n\n\n2023-08-15 12:59:00\nMcDougallCreekWildfire-BC-Canada-Aug-23\npre\n2\n\n\n2023-08-09 01:00:00\nMaui-Hawaii-fires-Aug-23\npost\n5\n\n\n2023-05-13 18:30:00\nBayofBengal-Cyclone-Mocha-May-23\npre\n3\n\n\n2023-05-13 18:30:00\nBayofBengal-Cyclone-Mocha-May-23\npost\n2\n\n\n2023-05-07 22:00:00\nKalehe-DRC-Flooding-5-8-23\npre\n1\n\n\n2023-05-07 22:00:00\nKalehe-DRC-Flooding-5-8-23\npost\n1\n\n\n2023-05-01 22:00:00\nEmilia-Romagna-Italy-flooding-may23\npre\n10\n\n\n2023-05-01 22:00:00\nEmilia-Romagna-Italy-flooding-may23\npost\n1\n\n\n2023-02-06 01:17:34\nKahramanmaras-turkey-earthquake-23\npre\n26\n\n\n2023-02-06 01:17:34\nKahramanmaras-turkey-earthquake-23\npost\n50\n\n\n2023-01-26 12:00:00\nNew-Zealand-Flooding23\npre\n2\n\n\n2023-01-26 12:00:00\nNew-Zealand-Flooding23\npost\n1\n\n\n2022-11-21 06:21:07\nIndonesia-Earthquake22\npre\n5\n\n\n2022-11-21 06:21:07\nIndonesia-Earthquake22\npost\n3\n\n\n2022-09-27 08:30:00\nHurricane-Ian-9-26-2022\npost\n27\n\n\n2022-09-27 08:30:00\nHurricane-Ian-9-26-2022\npre\n62\n\n\n2022-09-18 04:00:00\nHurricane-Fiona-9-19-2022\npre\n6\n\n\n2022-09-18 04:00:00\nHurricane-Fiona-9-19-2022\npost\n10\n\n\n2022-08-21 22:00:00\nSudan-flooding-8-22-2022\npre\n3\n\n\n2022-08-21 22:00:00\nSudan-flooding-8-22-2022\npost\n4\n\n\n2022-08-11 00:00:00\nGambia-flooding-8-11-2022\npre\n3\n\n\n2022-08-11 00:00:00\nGambia-flooding-8-11-2022\npost\n3\n\n\n2022-08-03 11:00:00\nshovi-georgia-landslide-8Aug23\npre\n2\n\n\n2022-08-03 11:00:00\nshovi-georgia-landslide-8Aug23\npost\n1\n\n\n2022-07-29 05:00:00\nkentucky-flooding-7-29-2022\npre\n6\n\n\n2022-07-29 05:00:00\nkentucky-flooding-7-29-2022\npost\n4\n\n\n2022-07-25 17:00:00\npakistan-flooding22\npost\n44\n\n\n2022-07-25 17:00:00\npakistan-flooding22\npre\n19\n\n\n2022-06-21 20:54:34\nafghanistan-earthquake22\npost\n7\n\n\n2022-06-21 20:54:34\nafghanistan-earthquake22\npre\n7\n\n\n2022-06-15 06:00:00\nyellowstone-flooding22\npost\n5\n\n\n2022-04-12 22:00:00\nsouthafrica-flooding22\npre\n2\n\n\n2022-04-12 22:00:00\nsouthafrica-flooding22\npost\n11\n\n\n2022-02-21 21:00:00\ncyclone-emnati22\npre\n5\n\n\n2022-02-21 21:00:00\ncyclone-emnati22\npost\n1\n\n\n2022-01-20 15:00:00\nghana-explosion22\npre\n2\n\n\n2022-01-20 15:00:00\nghana-explosion22\npost\n1\n\n\n2022-01-13 15:20:00\ntonga-volcano21\npre\n1\n\n\n2022-01-13 15:20:00\ntonga-volcano21\npost\n9\n\n\n2021-12-30 06:00:00\nMarshall-Fire-21-Update\npost\n1\n\n\n2021-12-04 07:50:00\nvolcano-indonesia21\npre\n3\n\n\n2021-12-04 07:50:00\nvolcano-indonesia21\npost\n4"
  },
  {
    "objectID": "posts/geo/natural-disasters-maxar-open-data/index.html#wrap-up",
    "href": "posts/geo/natural-disasters-maxar-open-data/index.html#wrap-up",
    "title": "Visualizing Natural Disasters through Dynamic Tiling and Maxar‚Äôs Open Data Program",
    "section": "Wrap-up",
    "text": "Wrap-up\nAlthough it may be difficult to claim that there is an overall increase in the number of natural disasters over the course of recent history, it is clear that the amount of recorded data that we as a society have on natural disasters is increasing. As this rate across our world increases and as the level of damage and destruction becomes more severe on Earth, there‚Äôs an ever growing need to analyze satellite sensor data to help respond to these events. Hopefully, more satellite imagery providers can follow the trend of continuing to release critical imagery to those who need it most in critical times of need.\nIf you have any thoughts or questions, feel free to let me know what you think in the comments below. You‚Äôll need to sign in to your GitHub account to do so. Like my work? Feel free to reach out.\nWe only have one rock, and it‚Äôs a beautiful one. Thanks for reading! ‚úåÔ∏èüåç\n\n\n\n\n\n\nFigure¬†10: 2023 Morocco Earthquake - Leaflet Split Map Example"
  }
]